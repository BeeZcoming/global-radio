<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球广播电台在线收听</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 120px;
        }

        .container {
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(229, 46, 113, 0.5);
        }

        .tagline {
            font-size: 1.1rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: #e52e71;
            box-shadow: 0 0 10px rgba(229, 46, 113, 0.5);
        }

        .search-box i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        select {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            color: white;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        select:focus {
            border-color: #ff8a00;
            box-shadow: 0 0 10px rgba(255, 138, 0, 0.5);
        }

        option {
            background: #302b63;
        }

        .sidebar {
            flex: 0 0 350px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ff8a00;
        }

        .radio-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .radio-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 138, 0, 0.3);
        }

        .radio-item.active {
            background: rgba(229, 46, 113, 0.2);
            border-color: rgba(229, 46, 113, 0.5);
        }

        .radio-flag {
            width: 30px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            font-size: 1.2rem;
            text-align: center;
        }

        .radio-info {
            flex: 1;
            min-width: 0;
        }

        .radio-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .radio-country, .radio-genre {
            font-size: 0.75rem;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .play-btn {
            background: #e52e71;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .play-btn:hover {
            background: #ff8a00;
            transform: scale(1.1);
        }

        #map {
            flex: 1;
            width: 100%;
            height: 100%;
            min-height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }

        .country-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .country-name {
            font-size: 1.2rem;
            color: #ff8a00;
            margin-bottom: 10px;
        }

        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .player-info {
            flex: 1;
            margin-left: 20px;
        }

        .player-station {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .player-country {
            color: #aaa;
            font-size: 0.9rem;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            color: #ff8a00;
        }

        .play-pause {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e52e71;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .play-pause:hover {
            background: #ff8a00;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            width: 100px;
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;
            padding: 10px 15px;
            background: rgba(255, 138, 0, 0.2);
            border-radius: 30px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 138, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 138, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 138, 0, 0); }
        }

        .now-playing i {
            color: #ff8a00;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #e52e71;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .favorite-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 8px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .favorite-btn.active {
            color: #ff8a00;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-size: 0.9rem;
        }

        .tab.active {
            color: #ff8a00;
            border-bottom: 2px solid #ff8a00;
        }

        .tab:hover {
            color: #ff8a00;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-time {
            font-size: 0.65rem;
            color: #aaa;
            margin-top: 2px;
        }

        .share-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s;
        }

        .share-btn:hover {
            color: #2196F3;
        }

        .load-more {
            text-align: center;
            padding: 15px 10px 25px 10px;
            margin-top: 10px;
        }

        .load-more-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .load-more-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff8a00;
            transform: translateY(-2px);
        }

        .region-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .region-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            flex: 1;
        }

        .region-btn.active {
            background: rgba(255, 138, 0, 0.2);
            color: #ff8a00;
            border-color: rgba(255, 138, 0, 0.5);
        }

        .region-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .data-source {
            font-size: 0.7rem;
            color: #aaa;
            text-align: center;
            margin-top: 5px;
        }

        .genre-stats {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .genre-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .genre-stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .genre-name {
            color: #ddd;
        }

        .genre-count {
            color: #ff8a00;
            font-weight: 600;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                flex: 1;
                max-height: 500px;
            }
            
            .map-container {
                min-height: 600px;
            }
        }

        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .player {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .player-controls {
                width: 100%;
                justify-content: center;
            }
            
            .sidebar {
                flex: 0 0 auto;
            }
            
            body {
                padding-bottom: 160px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-globe-americas"></i> 全球广播电台</h1>
        <p class="tagline">探索世界各地的广播电台，随时收听全球声音</p>
    </header>

    <div class="container">
        <div class="sidebar">
            <h2 class="section-title">电台列表</h2>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="搜索电台名称、国家或类型...">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            
            <div class="region-selector">
                <button class="region-btn active" data-region="all">全部</button>
                <button class="region-btn" data-region="asia">亚洲</button>
                <button class="region-btn" data-region="europe">欧洲</button>
                <button class="region-btn" data-region="americas">美洲</button>
                <button class="region-btn" data-region="africa">非洲</button>
                <button class="region-btn" data-region="oceania">大洋洲</button>
            </div>
            
            <div class="filter-container">
                <select id="country-filter">
                    <option value="">所有国家</option>
                </select>
                <select id="language-filter">
                    <option value="">所有语言</option>
                </select>
                <select id="genre-filter">
                    <option value="">所有类型</option>
                </select>
            </div>
            
            <div class="stats">
                <span id="total-stations">加载中...</span>
                <span id="filtered-stations"></span>
            </div>

            <div class="popular-genres">
                <div class="section-title">热门类型</div>
                <div id="genre-stats" class="genre-stats">
                    <div class="loading">加载中...</div>
                </div>
            </div>
            
            <div class="data-source" id="data-source">数据来源: 本地数据</div>
            
            <div class="tabs">
                <div class="tab active" data-tab="all">全部电台</div>
                <div class="tab" data-tab="favorites">收藏</div>
                <div class="tab" data-tab="history">播放历史</div>
            </div>
            
            <div class="tab-content active" id="all-stations">
                <div class="radio-list" id="radio-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载电台列表...
                    </div>
                </div>
                <div class="load-more">
                    <button class="load-more-btn" id="load-more-btn" style="display: none;">加载更多电台</button>
                </div>
            </div>
            
            <div class="tab-content" id="favorites-stations">
                <div class="radio-list" id="favorites-list">
                    <div class="loading">暂无收藏的电台</div>
                </div>
            </div>
            
            <div class="tab-content" id="history-stations">
                <div class="radio-list" id="history-list">
                    <div class="loading">暂无播放历史</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="map-container">
                <h2 class="section-title">世界地图</h2>
                <div id="map"></div>
                <div class="country-info">
                    <div class="country-name" id="selected-country">全球电台</div>
                    <p id="country-station-count">点击地图上的标记或使用筛选器选择电台</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="player">
        <div class="now-playing">
            <i class="fas fa-music"></i>
            <span>正在播放</span>
        </div>
        
        <div class="player-info">
            <div class="player-station" id="current-station">请选择一个电台开始播放</div>
            <div class="player-country" id="current-country"></div>
        </div>
        
        <div class="player-controls">
            <button class="control-btn play-pause" id="play-pause-btn"><i class="fas fa-play"></i></button>
            <button class="control-btn stop-btn" id="stop-btn"><i class="fas fa-stop"></i></button>
            
            <div class="volume-container">
                <button class="control-btn volume-btn"><i class="fas fa-volume-up"></i></button>
                <input type="range" class="volume-slider" min="0" max="100" value="80">
            </div>

            <button class="control-btn share-btn" id="share-btn"><i class="fas fa-share-alt"></i></button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // 初始化变量
        let currentStation = null;
        let isPlaying = false;
        let audioPlayer = new Audio();
        let allStations = [];
        let filteredStations = [];
        let displayedStations = [];
        let favoriteStations = [];
        let historyStations = [];
        let map;
        let markers = [];
        let countries = [];
        let languages = [];
        let genres = [];
        let searchTimeout;
        let activeTab = 'all';
        let currentRegion = 'all';
        let displayLimit = 100;
        let displayedCount = 0;

        // 数据源配置
        const DATA_SOURCES = {
            primary: 'data/curated-stations.json',
            asia: 'data/asia-stations.json',
            europe: 'data/europe-stations.json',
            americas: 'data/americas-stations.json',
            africa: 'data/africa-stations.json',
            oceania: 'data/oceania-stations.json',
            fallback: 'https://de1.api.radio-browser.info/json/stations?limit=100&hidebroken=true&order=votes&reverse=true'
        };

        // 扩展语言映射
        const languageMapping = {
            'chinese': '中文', 'english': '英语', 'french': '法语', 'german': '德语',
            'spanish': '西班牙语', 'japanese': '日语', 'korean': '韩语', 'russian': '俄语',
            'arabic': '阿拉伯语', 'portuguese': '葡萄牙语', 'italian': '意大利语', 'dutch': '荷兰语',
            'hindi': '印地语', 'turkish': '土耳其语', 'vietnamese': '越南语', 'thai': '泰语'
        };

        // 扩展类型映射
        const genreMapping = {
            // 音乐类型
            'music': '音乐', 'classical': '古典', 'rock': '摇滚', 'pop': '流行', 'jazz': '爵士',
            'electronic': '电子', 'country': '乡村', 'folk': '民谣', 'blues': '蓝调', 'reggae': '雷鬼',
            'hiphop': '嘻哈', 'rap': '说唱', 'metal': '金属', 'indie': '独立', 'dance': '舞曲',
            'house': '浩室', 'techno': '科技', 'trance': '迷幻', 'latin': '拉丁', 'world': '世界音乐',
            
            // 新闻资讯
            'news': '新闻', 'talk': '谈话', 'business': '财经', 'politics': '政治', 'sports': '体育',
            'weather': '天气', 'traffic': '交通',
            
            // 文化教育
            'education': '教育', 'culture': '文化', 'religious': '宗教', 'history': '历史',
            'science': '科学', 'technology': '科技', 'arts': '艺术',
            
            // 娱乐生活
            'entertainment': '娱乐', 'comedy': '喜剧', 'lifestyle': '生活', 'health': '健康',
            'fashion': '时尚', 'food': '美食', 'travel': '旅游',
            
            // 特殊类型
            'children': '儿童', 'family': '家庭', 'community': '社区', 'local': '本地',
            'regional': '区域', 'national': '全国', 'international': '国际'
        };

        // 地区国家映射
        const regionCountries = {
            'asia': ['China', 'Japan', 'South Korea', 'India', 'Indonesia', 'Thailand', 'Vietnam', 'Malaysia', 'Philippines', 'Singapore', 'Taiwan', 'Hong Kong'],
            'europe': ['United Kingdom', 'Germany', 'France', 'Italy', 'Spain', 'Netherlands', 'Sweden', 'Norway', 'Finland', 'Denmark', 'Switzerland', 'Austria'],
            'americas': ['United States', 'Canada', 'Mexico', 'Brazil', 'Argentina', 'Chile', 'Colombia', 'Peru', 'Venezuela', 'Cuba'],
            'africa': ['South Africa', 'Egypt', 'Nigeria', 'Kenya', 'Morocco', 'Ethiopia', 'Ghana', 'Tanzania', 'Algeria'],
            'oceania': ['Australia', 'New Zealand', 'Fiji', 'Papua New Guinea']
        };

        // 从预处理的JSON文件加载数据
        async function loadPreprocessedData() {
            console.log('开始加载数据...');
            const loadingElement = document.getElementById('radio-list');
            loadingElement.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 正在加载电台数据...</div>';
            
            try {
                let response = await fetch(DATA_SOURCES.primary);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('成功加载数据，电台数量:', data.stations.length);
                    processStationsData(data.stations);
                    updateDataSource('本地数据');
                    return;
                } else {
                    console.error('主数据加载失败，状态:', response.status);
                }

                await loadRegionalData();
                
            } catch (error) {
                console.error('本地数据加载失败:', error);
                await loadFromOriginalAPI();
            }
        }

        // 按地区加载数据
        async function loadRegionalData() {
            try {
                const regions = ['asia', 'europe', 'americas', 'africa', 'oceania'];
                let allStationsData = [];
                
                for (const region of regions) {
                    const response = await fetch(DATA_SOURCES[region]);
                    if (response.ok) {
                        const data = await response.json();
                        allStationsData = allStationsData.concat(data.stations);
                    }
                }
                
                if (allStationsData.length > 0) {
                    processStationsData(allStationsData);
                    updateDataSource('地区数据');
                    return true;
                }
            } catch (error) {
                console.error('地区数据加载失败:', error);
            }
            return false;
        }

        // 从原始API加载数据（备用方案）
        async function loadFromOriginalAPI() {
            try {
                const response = await fetch(DATA_SOURCES.fallback);
                if (response.ok) {
                    const stations = await response.json();
                    processStationsData(stations);
                    updateDataSource('原始API');
                    return;
                }
            } catch (error) {
                console.error('原始API加载失败:', error);
                loadFallbackData();
            }
        }

        // 加载备用数据
        function loadFallbackData() {
            console.log('使用备用数据');
            
            allStations = [
                {
                    stationuuid: '1',
                    name: 'BBC Radio 1',
                    country: 'United Kingdom',
                    countrycode: 'GB',
                    url_resolved: 'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_one',
                    tags: 'pop,music',
                    language: 'english',
                    votes: 1000,
                    geo_lat: 51.5074,
                    geo_long: -0.1278
                }
            ];
            
            processStationsData(allStations);
            updateDataSource('示例数据');
        }

        // 处理电台数据
        function processStationsData(stations) {
            allStations = stations.filter(station => 
                station && (station.url_resolved || station.url)
            );
            
            updateStats();
            extractFilterOptions();
            updateGenreStats();
            
            displayedCount = 0;
            displayedStations = [];
            filteredStations = [...allStations];
            
            loadMoreStations();
            updateMapMarkers(allStations.slice(0, 500));
            
            console.log(`成功加载 ${allStations.length} 个电台`);
        }

        // 提取筛选选项
        function extractFilterOptions() {
            extractCountries();
            extractLanguages();
            extractGenres();
        }

        // 加载更多电台
        function loadMoreStations() {
            const startIndex = displayedCount;
            const endIndex = Math.min(displayedCount + 100, filteredStations.length);
            
            if (startIndex >= filteredStations.length) {
                document.getElementById('load-more-btn').style.display = 'none';
                return;
            }
            
            const stationsToAdd = filteredStations.slice(startIndex, endIndex);
            displayedStations = displayedStations.concat(stationsToAdd);
            displayedCount = endIndex;
            
            renderRadioList(displayedStations, document.getElementById('radio-list'), 'all');
            updateStats();
            updateLoadMoreButton();
        }

        // 更新加载更多按钮
        function updateLoadMoreButton() {
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (displayedCount >= filteredStations.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
                const remaining = filteredStations.length - displayedCount;
                loadMoreBtn.textContent = `加载更多 (${remaining} 个电台)`;
            }
        }

        // 更新统计信息
        function updateStats() {
            const totalDisplay = `${allStations.length.toLocaleString()} 电台 / ${countries.length} 国家`;
            document.getElementById('total-stations').textContent = totalDisplay;
            
            const currentDisplayCount = Math.min(displayedCount, filteredStations.length);
            const displayedCountText = `显示: ${currentDisplayCount}/${filteredStations.length}`;
            document.getElementById('filtered-stations').textContent = displayedCountText;
        }

        // 更新类型统计
        function updateGenreStats() {
            const genreCount = {};
            
            allStations.forEach(station => {
                if (station.tags) {
                    const stationGenres = station.tags.split(',').map(tag => tag.trim().toLowerCase());
                    stationGenres.forEach(genre => {
                        if (genre && genre.length > 2) {
                            genreCount[genre] = (genreCount[genre] || 0) + 1;
                        }
                    });
                }
            });
            
            const popularGenres = Object.entries(genreCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const statsContainer = document.getElementById('genre-stats');
            if (popularGenres.length > 0) {
                statsContainer.innerHTML = popularGenres.map(([genre, count]) => `
                    <div class="genre-stat-item" data-genre="${genre}">
                        <span class="genre-name">${formatGenre(genre)}</span>
                        <span class="genre-count">${count}</span>
                    </div>
                `).join('');
                
                // 添加点击事件
                document.querySelectorAll('.genre-stat-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const genre = this.dataset.genre;
                        document.getElementById('search-input').value = genre;
                        performSearch();
                    });
                });
            } else {
                statsContainer.innerHTML = '<div class="loading">暂无类型数据</div>';
            }
        }

        // 格式化类型显示
        function formatGenre(genre) {
            const genreLower = genre.toLowerCase();
            if (genreMapping[genreLower]) {
                return genreMapping[genreLower];
            }
            
            // 模糊匹配
            const fuzzyMap = {
                'oldies': '经典老歌', 'top40': '流行金曲', 'hits': '热门金曲',
                'rnb': '节奏蓝调', 'r&b': '节奏蓝调', 'edm': '电子舞曲',
                'kpop': '韩流', 'jpop': '日流', 'cpop': '华语流行'
            };
            
            for (const [key, value] of Object.entries(fuzzyMap)) {
                if (genreLower.includes(key)) {
                    return value;
                }
            }
            
            return genre;
        }

        // 格式化标签显示
        function formatGenres(tags) {
            if (!tags) return '未分类';
            
            const genreList = tags.split(',').slice(0, 2).map(genre => {
                return formatGenre(genre.trim());
            });
            
            return genreList.join(' · ');
        }

        // 更新数据源显示
        function updateDataSource(source) {
            const sourceElement = document.getElementById('data-source');
            if (sourceElement) {
                sourceElement.textContent = `数据来源: ${source}`;
            }
        }

        // 提取国家列表
        function extractCountries() {
            const countrySet = new Set();
            allStations.forEach(station => {
                if (station.country) countrySet.add(station.country);
            });
            
            countries = Array.from(countrySet).sort();
            
            const countryFilter = document.getElementById('country-filter');
            countryFilter.innerHTML = '<option value="">所有国家</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        // 提取语言列表
        function extractLanguages() {
            const languageSet = new Set();
            
            allStations.forEach(station => {
                if (station.language) {
                    const stationLanguages = station.language.split(',').map(lang => lang.trim().toLowerCase());
                    stationLanguages.forEach(lang => {
                        if (lang && languageMapping[lang]) {
                            languageSet.add(languageMapping[lang]);
                        }
                    });
                }
            });
            
            languages = Array.from(languageSet).sort();
            
            const languageFilter = document.getElementById('language-filter');
            languageFilter.innerHTML = '<option value="">所有语言</option>';
            
            languages.forEach(language => {
                const option = document.createElement('option');
                option.value = language;
                option.textContent = language;
                languageFilter.appendChild(option);
            });
        }

        // 提取类型列表
        function extractGenres() {
            const genreSet = new Set();
            
            allStations.forEach(station => {
                if (station.tags) {
                    const stationGenres = station.tags.split(',').map(tag => tag.trim().toLowerCase());
                    stationGenres.forEach(genre => {
                        const formattedGenre = formatGenre(genre);
                        if (formattedGenre && formattedGenre !== '未分类') {
                            genreSet.add(formattedGenre);
                        }
                    });
                }
            });
            
            genres = Array.from(genreSet).sort();
            
            const genreFilter = document.getElementById('genre-filter');
            genreFilter.innerHTML = '<option value="">所有类型</option>';
            
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }

        // 渲染电台列表
        function renderRadioList(stations = displayedStations, container = document.getElementById('radio-list'), listType = 'all') {
            if (!container) return;
            
            if (stations.length === 0) {
                if (listType === 'favorites') {
                    container.innerHTML = '<div class="loading">暂无收藏的电台</div>';
                } else if (listType === 'history') {
                    container.innerHTML = '<div class="loading">暂无播放历史</div>';
                } else {
                    container.innerHTML = '<div class="loading">未找到匹配的电台</div>';
                }
                return;
            }
            
            container.innerHTML = '';
            
            stations.forEach(station => {
                const radioItem = document.createElement('div');
                radioItem.className = 'radio-item';
                if (currentStation && currentStation.stationuuid === station.stationuuid) {
                    radioItem.classList.add('active');
                }
                radioItem.dataset.id = station.stationuuid;
                
                const flagEmoji = getFlagEmoji(station.countrycode);
                const isFavorite = favoriteStations.some(fav => fav.stationuuid === station.stationuuid);
                
                radioItem.innerHTML = `
                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-id="${station.stationuuid}">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="radio-flag">${flagEmoji}</div>
                    <div class="radio-info">
                        <div class="radio-name">${station.name || '未知电台'}</div>
                        <div class="radio-country">${station.country || '未知国家'}</div>
                        <div class="radio-genre">${formatGenres(station.tags)}</div>
                    </div>
                    <button class="play-btn" data-id="${station.stationuuid}">
                        <i class="fas fa-play"></i>
                    </button>
                `;
                
                container.appendChild(radioItem);
            });
            
            attachEventListeners();
        }

        // 附加事件监听器
        function attachEventListeners() {
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const stationId = this.dataset.id;
                    playStation(stationId);
                });
            });
            
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const stationId = this.dataset.id;
                    toggleFavorite(stationId);
                });
            });
            
            document.querySelectorAll('.radio-item').forEach(item => {
                item.addEventListener('click', function() {
                    const stationId = this.dataset.id;
                    playStation(stationId);
                });
            });
        }

        // 播放电台
        function playStation(stationId) {
            const station = allStations.find(s => s.stationuuid === stationId);
            if (!station) return;
            
            currentStation = station;
            document.getElementById('current-station').textContent = station.name || '未知电台';
            document.getElementById('current-country').textContent = `${station.country || '未知国家'} • ${formatGenres(station.tags)}`;
            
            const playPauseBtn = document.getElementById('play-pause-btn');
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            isPlaying = true;
            
            addToHistory(station);
            
            document.querySelectorAll('.radio-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === stationId) {
                    item.classList.add('active');
                }
            });
            
            // 修复：地图跳转到电台位置
            if (station.geo_lat && station.geo_long) {
                map.setView([station.geo_lat, station.geo_long], 6, {
                    animate: true,
                    duration: 1
                });
                
                // 高亮对应的地图标记
                markers.forEach(marker => {
                    const markerLat = marker.getLatLng().lat;
                    const markerLng = marker.getLatLng().lng;
                    if (markerLat === station.geo_lat && markerLng === station.geo_long) {
                        marker.openPopup();
                    }
                });
            }
            
            audioPlayer.pause();
            
            const streamUrl = station.url_resolved || station.url;
            audioPlayer.src = streamUrl;
            audioPlayer.play().catch(error => {
                console.error('播放失败:', error);
                document.getElementById('current-station').textContent = '播放失败，请尝试其他电台';
                document.getElementById('current-station').style.color = '#e52e71';
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
                
                setTimeout(() => {
                    if (document.getElementById('current-station')) {
                        document.getElementById('current-station').style.color = '';
                    }
                }, 3000);
            });
        }

        // 初始化地图
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // 更新地图标记
        function updateMapMarkers(stations) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            stations.forEach(station => {
                if (station.geo_lat && station.geo_long) {
                    const flagEmoji = getFlagEmoji(station.countrycode);
                    
                    const marker = L.marker([station.geo_lat, station.geo_long])
                        .addTo(map)
                        .bindPopup(`
                            <div style="color: black; min-width: 200px;">
                                <b>${station.name || '未知电台'}</b><br>
                                ${station.country || ''}<br>
                                <small>${formatGenres(station.tags)}</small><br>
                                <button onclick="window.playStationFromMap('${station.stationuuid}')" 
                                        style="background:#e52e71;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;margin-top:5px;">
                                    播放
                                </button>
                            </div>
                        `);
                    
                    markers.push(marker);
                }
            });
        }

        // 从地图播放电台
        window.playStationFromMap = function(stationId) {
            playStation(stationId);
        };

        // 防抖搜索
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300);
        }

        // 执行搜索
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const countryFilter = document.getElementById('country-filter').value;
            const languageFilter = document.getElementById('language-filter').value;
            const genreFilter = document.getElementById('genre-filter').value;
            
            filteredStations = allStations.filter(station => {
                const matchesSearch = searchTerm === '' || 
                    (station.name && station.name.toLowerCase().includes(searchTerm)) || 
                    (station.country && station.country.toLowerCase().includes(searchTerm)) ||
                    (station.tags && station.tags.toLowerCase().includes(searchTerm));
                
                const matchesCountry = countryFilter === '' || station.country === countryFilter;
                
                let matchesLanguage = true;
                if (languageFilter !== '') {
                    const englishKeyword = Object.keys(languageMapping).find(key => 
                        languageMapping[key] === languageFilter
                    ) || '';
                    matchesLanguage = station.language && 
                        station.language.toLowerCase().includes(englishKeyword.toLowerCase());
                }
                
                let matchesGenre = true;
                if (genreFilter !== '') {
                    const englishKeyword = Object.keys(genreMapping).find(key => 
                        genreMapping[key] === genreFilter
                    ) || '';
                    matchesGenre = station.tags && 
                        station.tags.toLowerCase().includes(englishKeyword.toLowerCase());
                }
                
                // 修复：地区筛选
                let matchesRegion = true;
                if (currentRegion !== 'all') {
                    const regionCountries = getRegionCountries(currentRegion);
                    matchesRegion = regionCountries.some(country => 
                        station.country && station.country.toLowerCase().includes(country.toLowerCase())
                    );
                }
                
                return matchesSearch && matchesCountry && matchesLanguage && matchesGenre && matchesRegion;
            });
            
            displayedCount = 0;
            displayedStations = [];
            
            if (activeTab === 'all') {
                loadMoreStations();
            }
            
            updateMapMarkers(filteredStations.slice(0, 200));
            updateCountryInfo();
        }

        // 获取地区对应的国家列表
        function getRegionCountries(region) {
            return regionCountries[region] || [];
        }

        // 更新国家信息显示
        function updateCountryInfo() {
            const countryName = document.getElementById('selected-country');
            const countryCount = document.getElementById('country-station-count');
            
            if (currentRegion !== 'all') {
                const regionNames = {
                    'asia': '亚洲', 'europe': '欧洲', 'americas': '美洲', 
                    'africa': '非洲', 'oceania': '大洋洲'
                };
                countryName.textContent = `${regionNames[currentRegion]}地区电台`;
                countryCount.textContent = `找到 ${filteredStations.length} 个电台`;
            } else if (document.getElementById('country-filter').value) {
                const selectedCountry = document.getElementById('country-filter').value;
                countryName.textContent = `${selectedCountry}电台`;
                countryCount.textContent = `找到 ${filteredStations.length} 个电台`;
            } else {
                countryName.textContent = '全球电台';
                countryCount.textContent = `点击地图上的标记或使用筛选器选择电台 (${filteredStations.length} 个电台)`;
            }
        }

        // 加载本地数据
        function loadLocalData() {
            const storedFavorites = localStorage.getItem('radioFavorites');
            const storedHistory = localStorage.getItem('radioHistory');
            
            if (storedFavorites) {
                favoriteStations = JSON.parse(storedFavorites);
            }
            
            if (storedHistory) {
                historyStations = JSON.parse(storedHistory);
            }
        }

        // 保存数据到localStorage
        function saveLocalData() {
            localStorage.setItem('radioFavorites', JSON.stringify(favoriteStations));
            localStorage.setItem('radioHistory', JSON.stringify(historyStations));
        }

        // 切换收藏状态
        function toggleFavorite(stationId) {
            const station = allStations.find(s => s.stationuuid === stationId);
            if (!station) return;
            
            const index = favoriteStations.findIndex(fav => fav.stationuuid === stationId);
            
            if (index === -1) {
                favoriteStations.push(station);
            } else {
                favoriteStations.splice(index, 1);
            }
            
            saveLocalData();
            
            if (activeTab === 'all') {
                renderRadioList();
            } else if (activeTab === 'favorites') {
                updateTabs();
            }
        }

        // 添加到播放历史
        function addToHistory(station) {
            const existingIndex = historyStations.findIndex(item => 
                item.station.stationuuid === station.stationuuid
            );
            
            if (existingIndex !== -1) {
                historyStations.splice(existingIndex, 1);
            }
            
            historyStations.push({
                station: station,
                timestamp: Date.now()
            });
            
            if (historyStations.length > 50) {
                historyStations = historyStations.slice(-50);
            }
            
            saveLocalData();
            
            if (activeTab === 'history') {
                updateTabs();
            }
        }

        // 根据国家代码获取国旗emoji
        function getFlagEmoji(countryCode) {
            if (!countryCode) return '🌐';
            
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        // 更新标签页内容
        function updateTabs() {
            if (activeTab === 'favorites') {
                renderRadioList(favoriteStations, document.getElementById('favorites-list'), 'favorites');
            } else if (activeTab === 'history') {
                renderHistoryList();
            }
        }

        // 渲染历史列表
        function renderHistoryList() {
            const historyList = document.getElementById('history-list');
            
            if (historyStations.length === 0) {
                historyList.innerHTML = '<div class="loading">暂无播放历史</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            const recentHistory = historyStations.slice(-20).reverse();
            
            recentHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.id = item.station.stationuuid;
                
                const flagEmoji = getFlagEmoji(item.station.countrycode);
                const timeString = new Date(item.timestamp).toLocaleString();
                
                historyItem.innerHTML = `
                    <div class="radio-flag">${flagEmoji}</div>
                    <div class="radio-info">
                        <div class="radio-name">${item.station.name || '未知电台'}</div>
                        <div class="radio-country">${item.station.country || '未知国家'}</div>
                        <div class="history-time">${timeString}</div>
                    </div>
                    <button class="play-btn" data-id="${item.station.stationuuid}">
                        <i class="fas fa-play"></i>
                    </button>
                `;
                
                historyList.appendChild(historyItem);
            });
            
            attachEventListeners();
        }

        // 播放控制
        function togglePlayPause() {
            if (!currentStation) {
                if (filteredStations.length > 0) {
                    playStation(filteredStations[0].stationuuid);
                }
                return;
            }
            
            if (isPlaying) {
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
                audioPlayer.pause();
            } else {
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
                audioPlayer.play().catch(error => {
                    console.error('播放失败:', error);
                    document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
                });
            }
            
            isPlaying = !isPlaying;
        }

        function stopPlayback() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            isPlaying = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
        }

        function updateVolume() {
            audioPlayer.volume = document.querySelector('.volume-slider').value / 100;
        }

        function shareStation() {
            if (!currentStation) {
                alert('请先选择一个电台');
                return;
            }
            
            const stationName = currentStation.name;
            const stationUrl = currentStation.url_resolved || currentStation.url;
            
            if (navigator.share) {
                navigator.share({
                    title: stationName,
                    text: '我正在收听这个电台',
                    url: stationUrl
                });
            } else {
                navigator.clipboard.writeText(`${stationName} - ${stationUrl}`).then(() => {
                    alert('电台链接已复制到剪贴板！');
                });
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadLocalData();
            loadPreprocessedData();
            
            // 事件监听器
            document.getElementById('search-input').addEventListener('input', debounceSearch);
            document.getElementById('country-filter').addEventListener('change', performSearch);
            document.getElementById('language-filter').addEventListener('change', performSearch);
            document.getElementById('genre-filter').addEventListener('change', performSearch);
            document.getElementById('load-more-btn').addEventListener('click', loadMoreStations);

            // 修复：地区选择联动
            document.querySelectorAll('.region-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentRegion = this.dataset.region;
                    
                    // 重置国家筛选
                    document.getElementById('country-filter').value = '';
                    
                    performSearch();
                    updateCountryInfo();
                });
            });

            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.dataset.tab;
                    document.getElementById(`${tabId}-stations`).classList.add('active');
                    
                    activeTab = tabId;
                    updateTabs();
                });
            });

            // 播放控制
            document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('stop-btn').addEventListener('click', stopPlayback);
            document.querySelector('.volume-slider').addEventListener('input', updateVolume);
            document.getElementById('share-btn').addEventListener('click', shareStation);
        });
    </script>
</body>
</html>
