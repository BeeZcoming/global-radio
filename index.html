<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒå¹¿æ’­ç”µå°åœ¨çº¿æ”¶å¬</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* ä¿æŒä¹‹å‰çš„CSSæ ·å¼ä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 120px;
        }

        .container {
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(229, 46, 113, 0.5);
        }

        .tagline {
            font-size: 1.1rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: #e52e71;
            box-shadow: 0 0 10px rgba(229, 46, 113, 0.5);
        }

        .search-box i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        select {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            color: white;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        select:focus {
            border-color: #ff8a00;
            box-shadow: 0 0 10px rgba(255, 138, 0, 0.5);
        }

        option {
            background: #302b63;
        }

        .sidebar {
            flex: 0 0 350px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ff8a00;
        }

        .radio-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .radio-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 138, 0, 0.3);
        }

        .radio-item.active {
            background: rgba(229, 46, 113, 0.2);
            border-color: rgba(229, 46, 113, 0.5);
        }

        .radio-flag {
            width: 30px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            font-size: 1.2rem;
            text-align: center;
        }

        .radio-info {
            flex: 1;
            min-width: 0;
        }

        .radio-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .radio-country, .radio-genre {
            font-size: 0.75rem;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .play-btn {
            background: #e52e71;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .play-btn:hover {
            background: #ff8a00;
            transform: scale(1.1);
        }

        #map {
            flex: 1;
            width: 100%;
            height: 100%;
            min-height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }

        .country-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .country-name {
            font-size: 1.2rem;
            color: #ff8a00;
            margin-bottom: 10px;
        }

        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .player-info {
            flex: 1;
            margin-left: 20px;
        }

        .player-station {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .player-country {
            color: #aaa;
            font-size: 0.9rem;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            color: #ff8a00;
        }

        .play-pause {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e52e71;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .play-pause:hover {
            background: #ff8a00;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            width: 100px;
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;
            padding: 10px 15px;
            background: rgba(255, 138, 0, 0.2);
            border-radius: 30px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 138, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 138, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 138, 0, 0); }
        }

        .now-playing i {
            color: #ff8a00;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #e52e71;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 0.8rem;
            color: #aaa;
        }

        .favorite-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 8px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .favorite-btn.active {
            color: #ff8a00;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-size: 0.9rem;
        }

        .tab.active {
            color: #ff8a00;
            border-bottom: 2px solid #ff8a00;
        }

        .tab:hover {
            color: #ff8a00;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-time {
            font-size: 0.65rem;
            color: #aaa;
            margin-top: 2px;
        }

        .share-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s;
        }

        .share-btn:hover {
            color: #2196F3;
        }

        .load-more {
            text-align: center;
            padding: 15px 10px 25px 10px;
            margin-top: 10px;
        }

        .load-more-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .load-more-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff8a00;
            transform: translateY(-2px);
        }

        .region-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .region-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            flex: 1;
        }

        .region-btn.active {
            background: rgba(255, 138, 0, 0.2);
            color: #ff8a00;
            border-color: rgba(255, 138, 0, 0.5);
        }

        .region-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .data-source {
            font-size: 0.7rem;
            color: #aaa;
            text-align: center;
            margin-top: 5px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                flex: 1;
                max-height: 500px;
            }
            
            .map-container {
                min-height: 600px;
            }
        }

        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .player {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .player-controls {
                width: 100%;
                justify-content: center;
            }
            
            .sidebar {
                flex: 0 0 auto;
            }
            
            body {
                padding-bottom: 160px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-globe-americas"></i> å…¨çƒå¹¿æ’­ç”µå°</h1>
        <p class="tagline">æ¢ç´¢ä¸–ç•Œå„åœ°çš„å¹¿æ’­ç”µå°ï¼Œéšæ—¶æ”¶å¬å…¨çƒå£°éŸ³</p>
    </header>

    <div class="container">
        <div class="sidebar">
            <h2 class="section-title">ç”µå°åˆ—è¡¨</h2>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢ç”µå°åç§°ã€å›½å®¶æˆ–ç±»å‹...">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            
            <div class="region-selector">
                <button class="region-btn active" data-region="all">å…¨éƒ¨</button>
                <button class="region-btn" data-region="asia">äºšæ´²</button>
                <button class="region-btn" data-region="europe">æ¬§æ´²</button>
                <button class="region-btn" data-region="americas">ç¾æ´²</button>
                <button class="region-btn" data-region="africa">éæ´²</button>
                <button class="region-btn" data-region="oceania">å¤§æ´‹æ´²</button>
            </div>
            
            <div class="filter-container">
                <select id="country-filter">
                    <option value="">æ‰€æœ‰å›½å®¶</option>
                </select>
                <select id="language-filter">
                    <option value="">æ‰€æœ‰è¯­è¨€</option>
                </select>
                <select id="genre-filter">
                    <option value="">æ‰€æœ‰ç±»å‹</option>
                </select>
            </div>
            
            <div class="stats">
                <span id="total-stations">åŠ è½½ä¸­...</span>
                <span id="filtered-stations"></span>
            </div>
            
            <div class="data-source" id="data-source">æ•°æ®æ¥æº: Radio Browser API</div>
            
            <div class="tabs">
                <div class="tab active" data-tab="all">å…¨éƒ¨ç”µå°</div>
                <div class="tab" data-tab="favorites">æ”¶è—</div>
                <div class="tab" data-tab="history">æ’­æ”¾å†å²</div>
            </div>
            
            <div class="tab-content active" id="all-stations">
                <div class="radio-list" id="radio-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½ç”µå°åˆ—è¡¨...
                    </div>
                </div>
                <div class="load-more">
                    <button class="load-more-btn" id="load-more-btn" style="display: none;">åŠ è½½æ›´å¤šç”µå°</button>
                </div>
            </div>
            
            <div class="tab-content" id="favorites-stations">
                <div class="radio-list" id="favorites-list">
                    <div class="loading">æš‚æ— æ”¶è—çš„ç”µå°</div>
                </div>
            </div>
            
            <div class="tab-content" id="history-stations">
                <div class="radio-list" id="history-list">
                    <div class="loading">æš‚æ— æ’­æ”¾å†å²</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="map-container">
                <h2 class="section-title">ä¸–ç•Œåœ°å›¾</h2>
                <div id="map"></div>
                <div class="country-info">
                    <div class="country-name" id="selected-country">å…¨çƒç”µå°</div>
                    <p id="country-station-count">ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°æˆ–ä½¿ç”¨ç­›é€‰å™¨é€‰æ‹©ç”µå°</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="player">
        <div class="now-playing">
            <i class="fas fa-music"></i>
            <span>æ­£åœ¨æ’­æ”¾</span>
        </div>
        
        <div class="player-info">
            <div class="player-station" id="current-station">è¯·é€‰æ‹©ä¸€ä¸ªç”µå°å¼€å§‹æ’­æ”¾</div>
            <div class="player-country" id="current-country"></div>
        </div>
        
        <div class="player-controls">
            <button class="control-btn play-pause" id="play-pause-btn"><i class="fas fa-play"></i></button>
            <button class="control-btn stop-btn" id="stop-btn"><i class="fas fa-stop"></i></button>
            
            <div class="volume-container">
                <button class="control-btn volume-btn"><i class="fas fa-volume-up"></i></button>
                <input type="range" class="volume-slider" min="0" max="100" value="80">
            </div>

            <button class="control-btn share-btn" id="share-btn"><i class="fas fa-share-alt"></i></button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–å˜é‡
        let currentStation = null;
        let isPlaying = false;
        let audioPlayer = new Audio();
        let allStations = [];
        let filteredStations = [];
        let displayedStations = [];
        let favoriteStations = [];
        let historyStations = [];
        let map;
        let markers = [];
        let countries = [];
        let languages = [];
        let genres = [];
        let searchTimeout;
        let activeTab = 'all';
        let currentRegion = 'all';
        let displayLimit = 50;
        let displayedCount = 0;

        // æ•°æ®æºé…ç½®
        const DATA_SOURCES = {
            // ä¸»æ•°æ®æº - é¢„å¤„ç†çš„ç²¾é€‰ç”µå°æ•°æ®
            primary: 'https://cdn.jsdelivr.net/gh/BeeZcoming/global-radio@main/data/curated-stations.json',
            asia: 'https://cdn.jsdelivr.net/gh/BeeZcoming/global-radio@main/data/asia-stations.json',
            europe: 'https://cdn.jsdelivr.net/gh/BeeZcoming/global-radio@main/data/europe-stations.json',
            americas: 'https://cdn.jsdelivr.net/gh/BeeZcoming/global-radio@main/data/americas-stations.json',
            africa: 'https://cdn.jsdelivr.net/gh/BeeZcoming/global-radio@main/data/africa-stations.json',
            oceania: 'https://cdn.jsdelivr.net/gh/BeeZcoming/global-radio@main/data/oceania-stations.json'
            
            // å¤‡ç”¨æ•°æ®æº - åŸå§‹API
            fallback: 'https://de1.api.radio-browser.info/json/stations?limit=1000&hidebroken=true&order=votes&reverse=true'
        };

        // è¯­è¨€æ˜ å°„
        const languageMapping = {
            'chinese': 'ä¸­æ–‡', 'english': 'è‹±è¯­', 'french': 'æ³•è¯­', 'german': 'å¾·è¯­',
            'spanish': 'è¥¿ç­ç‰™è¯­', 'japanese': 'æ—¥è¯­', 'korean': 'éŸ©è¯­', 'russian': 'ä¿„è¯­',
            'arabic': 'é˜¿æ‹‰ä¼¯è¯­', 'portuguese': 'è‘¡è„ç‰™è¯­', 'italian': 'æ„å¤§åˆ©è¯­', 'dutch': 'è·å…°è¯­'
        };

        // ç±»å‹æ˜ å°„
        const genreMapping = {
            'news': 'æ–°é—»', 'music': 'éŸ³ä¹', 'talk': 'è°ˆè¯', 'sports': 'ä½“è‚²',
            'business': 'è´¢ç»', 'education': 'æ•™è‚²', 'religious': 'å®—æ•™', 'culture': 'æ–‡åŒ–',
            'entertainment': 'å¨±ä¹', 'classical': 'å¤å…¸', 'rock': 'æ‘‡æ»š', 'pop': 'æµè¡Œ',
            'jazz': 'çˆµå£«', 'electronic': 'ç”µå­', 'country': 'ä¹¡æ‘'
        };

        // ä»é¢„å¤„ç†çš„JSONæ–‡ä»¶åŠ è½½æ•°æ®
        async function loadPreprocessedData() {
            const loadingElement = document.getElementById('radio-list');
            loadingElement.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½ç”µå°æ•°æ®...</div>';
            
            try {
                // é¦–å…ˆå°è¯•åŠ è½½æœ¬åœ°å­˜å‚¨çš„ç¼“å­˜æ•°æ®
                if (loadLocalCache()) {
                    updateDataSource('æœ¬åœ°ç¼“å­˜');
                    return;
                }

                // å°è¯•ä¸»æ•°æ®æº
                let response = await fetch(DATA_SOURCES.primary);
                if (response.ok) {
                    const data = await response.json();
                    processStationsData(data.stations);
                    cacheStationsData(data.stations);
                    updateDataSource('é¢„å¤„ç†æ•°æ®');
                    return;
                }

                // å¦‚æœä¸»æ•°æ®æºå¤±è´¥ï¼Œå°è¯•æŒ‰åœ°åŒºåŠ è½½
                await loadRegionalData();
                
            } catch (error) {
                console.error('é¢„å¤„ç†æ•°æ®åŠ è½½å¤±è´¥:', error);
                // æœ€åå°è¯•åŸå§‹API
                await loadFromOriginalAPI();
            }
        }

        // æŒ‰åœ°åŒºåŠ è½½æ•°æ®
        async function loadRegionalData() {
            try {
                const regions = ['asia', 'europe', 'americas', 'africa', 'oceania'];
                let allStationsData = [];
                
                for (const region of regions) {
                    const response = await fetch(DATA_SOURCES[region]);
                    if (response.ok) {
                        const data = await response.json();
                        allStationsData = allStationsData.concat(data.stations);
                    }
                }
                
                if (allStationsData.length > 0) {
                    processStationsData(allStationsData);
                    cacheStationsData(allStationsData);
                    updateDataSource('åœ°åŒºæ•°æ®');
                    return true;
                }
            } catch (error) {
                console.error('åœ°åŒºæ•°æ®åŠ è½½å¤±è´¥:', error);
            }
            return false;
        }

        // ä»åŸå§‹APIåŠ è½½æ•°æ®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        async function loadFromOriginalAPI() {
            try {
                const response = await fetch(DATA_SOURCES.fallback);
                if (response.ok) {
                    const stations = await response.json();
                    processStationsData(stations);
                    cacheStationsData(stations);
                    updateDataSource('åŸå§‹API');
                    return;
                }
            } catch (error) {
                console.error('åŸå§‹APIåŠ è½½å¤±è´¥:', error);
                loadFallbackData();
            }
        }

        // åŠ è½½æœ¬åœ°ç¼“å­˜
        function loadLocalCache() {
            try {
                const cachedData = localStorage.getItem('radioStationsCache');
                const cacheTimestamp = localStorage.getItem('radioCacheTimestamp');
                
                if (cachedData && cacheTimestamp) {
                    const cacheAge = Date.now() - parseInt(cacheTimestamp);
                    // ç¼“å­˜æœ‰æ•ˆæœŸ7å¤©
                    if (cacheAge < 7 * 24 * 60 * 60 * 1000) {
                        const stations = JSON.parse(cachedData);
                        processStationsData(stations);
                        return true;
                    }
                }
            } catch (error) {
                console.warn('æœ¬åœ°ç¼“å­˜åŠ è½½å¤±è´¥:', error);
            }
            return false;
        }

        // ç¼“å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function cacheStationsData(stations) {
            try {
                localStorage.setItem('radioStationsCache', JSON.stringify(stations));
                localStorage.setItem('radioCacheTimestamp', Date.now().toString());
            } catch (error) {
                console.warn('æœ¬åœ°å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ç¼“å­˜æ•°æ®');
            }
        }

        // æ›´æ–°æ•°æ®æºæ˜¾ç¤º
        function updateDataSource(source) {
            const sourceElement = document.getElementById('data-source');
            if (sourceElement) {
                sourceElement.textContent = `æ•°æ®æ¥æº: ${source}`;
            }
        }

        // å¤„ç†ç”µå°æ•°æ®
        function processStationsData(stations) {
            // è¿‡æ»¤æœ‰æ•ˆç”µå°
            allStations = stations.filter(station => 
                station && (station.url_resolved || station.url)
            );
            
            filteredStations = [...allStations];
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            // æå–ç­›é€‰é€‰é¡¹
            extractFilterOptions();
            
            // åˆå§‹æ˜¾ç¤º
            displayedCount = 0;
            displayedStations = [];
            loadMoreStations();
            
            // æ›´æ–°åœ°å›¾ï¼ˆé™åˆ¶æ•°é‡é¿å…æ€§èƒ½é—®é¢˜ï¼‰
            updateMapMarkers(allStations.slice(0, 500));
            
            console.log(`æˆåŠŸåŠ è½½ ${allStations.length} ä¸ªç”µå°`);
        }

        // æå–ç­›é€‰é€‰é¡¹
        function extractFilterOptions() {
            extractCountries();
            extractLanguages();
            extractGenres();
        }

        // åŠ è½½æ›´å¤šç”µå°
        function loadMoreStations() {
            const startIndex = displayedCount;
            const endIndex = Math.min(displayedCount + displayLimit, filteredStations.length);
            
            if (startIndex >= filteredStations.length) {
                document.getElementById('load-more-btn').style.display = 'none';
                return;
            }
            
            const stationsToAdd = filteredStations.slice(startIndex, endIndex);
            displayedStations = displayedStations.concat(stationsToAdd);
            displayedCount = endIndex;
            
            renderRadioList(displayedStations, document.getElementById('radio-list'), 'all');
            updateStats();
            updateLoadMoreButton();
        }

        // æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®
        function updateLoadMoreButton() {
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (displayedCount >= filteredStations.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
                const remaining = filteredStations.length - displayedCount;
                loadMoreBtn.textContent = `åŠ è½½æ›´å¤š (${remaining} ä¸ªç”µå°)`;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalDisplay = `${allStations.length.toLocaleString()} ç”µå° / ${countries.length} å›½å®¶`;
            document.getElementById('total-stations').textContent = totalDisplay;
            
            const currentDisplayCount = Math.min(displayedCount, filteredStations.length);
            const displayedCountText = `æ˜¾ç¤º: ${currentDisplayCount}/${filteredStations.length}`;
            document.getElementById('filtered-stations').textContent = displayedCountText;
        }

        // æå–å›½å®¶åˆ—è¡¨
        function extractCountries() {
            const countrySet = new Set();
            allStations.forEach(station => {
                if (station.country) countrySet.add(station.country);
            });
            
            countries = Array.from(countrySet).sort();
            
            const countryFilter = document.getElementById('country-filter');
            countryFilter.innerHTML = '<option value="">æ‰€æœ‰å›½å®¶</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        // æå–è¯­è¨€åˆ—è¡¨
        function extractLanguages() {
            const languageSet = new Set();
            
            allStations.forEach(station => {
                if (station.language) {
                    const stationLanguages = station.language.split(',').map(lang => lang.trim().toLowerCase());
                    stationLanguages.forEach(lang => {
                        if (lang && languageMapping[lang]) {
                            languageSet.add(languageMapping[lang]);
                        }
                    });
                }
            });
            
            languages = Array.from(languageSet).sort();
            
            const languageFilter = document.getElementById('language-filter');
            languageFilter.innerHTML = '<option value="">æ‰€æœ‰è¯­è¨€</option>';
            
            languages.forEach(language => {
                const option = document.createElement('option');
                option.value = language;
                option.textContent = language;
                languageFilter.appendChild(option);
            });
        }

        // æå–ç±»å‹åˆ—è¡¨
        function extractGenres() {
            const genreSet = new Set();
            
            allStations.forEach(station => {
                if (station.tags) {
                    const stationGenres = station.tags.split(',').map(tag => tag.trim().toLowerCase());
                    stationGenres.forEach(genre => {
                        if (genre && genreMapping[genre]) {
                            genreSet.add(genreMapping[genre]);
                        }
                    });
                }
            });
            
            genres = Array.from(genreSet).sort();
            
            const genreFilter = document.getElementById('genre-filter');
            genreFilter.innerHTML = '<option value="">æ‰€æœ‰ç±»å‹</option>';
            
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }

        // æ¸²æŸ“ç”µå°åˆ—è¡¨
        function renderRadioList(stations = displayedStations, container = document.getElementById('radio-list'), listType = 'all') {
            if (!container) return;
            
            if (stations.length === 0) {
                if (listType === 'favorites') {
                    container.innerHTML = '<div class="loading">æš‚æ— æ”¶è—çš„ç”µå°</div>';
                } else if (listType === 'history') {
                    container.innerHTML = '<div class="loading">æš‚æ— æ’­æ”¾å†å²</div>';
                } else {
                    container.innerHTML = '<div class="loading">æœªæ‰¾åˆ°åŒ¹é…çš„ç”µå°</div>';
                }
                return;
            }
            
            container.innerHTML = '';
            
            stations.forEach(station => {
                const radioItem = document.createElement('div');
                radioItem.className = 'radio-item';
                if (currentStation && currentStation.stationuuid === station.stationuuid) {
                    radioItem.classList.add('active');
                }
                radioItem.dataset.id = station.stationuuid;
                
                const flagEmoji = getFlagEmoji(station.countrycode);
                const isFavorite = favoriteStations.some(fav => fav.stationuuid === station.stationuuid);
                
                radioItem.innerHTML = `
                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-id="${station.stationuuid}">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="radio-flag">${flagEmoji}</div>
                    <div class="radio-info">
                        <div class="radio-name">${station.name || 'æœªçŸ¥ç”µå°'}</div>
                        <div class="radio-country">${station.country || 'æœªçŸ¥å›½å®¶'}</div>
                        <div class="radio-genre">${station.tags || 'æœªåˆ†ç±»'}</div>
                    </div>
                    <button class="play-btn" data-id="${station.stationuuid}">
                        <i class="fas fa-play"></i>
                    </button>
                `;
                
                container.appendChild(radioItem);
            });
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            attachEventListeners();
        }

        // é™„åŠ äº‹ä»¶ç›‘å¬å™¨
        function attachEventListeners() {
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const stationId = this.dataset.id;
                    playStation(stationId);
                });
            });
            
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const stationId = this.dataset.id;
                    toggleFavorite(stationId);
                });
            });
            
            document.querySelectorAll('.radio-item').forEach(item => {
                item.addEventListener('click', function() {
                    const stationId = this.dataset.id;
                    playStation(stationId);
                });
            });
        }

        // æ’­æ”¾ç”µå°
        function playStation(stationId) {
            const station = allStations.find(s => s.stationuuid === stationId);
            if (!station) return;
            
            currentStation = station;
            document.getElementById('current-station').textContent = station.name || 'æœªçŸ¥ç”µå°';
            document.getElementById('current-country').textContent = `${station.country || 'æœªçŸ¥å›½å®¶'} â€¢ ${station.tags || 'æœªåˆ†ç±»'}`;
            
            const playPauseBtn = document.getElementById('play-pause-btn');
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            isPlaying = true;
            
            addToHistory(station);
            
            document.querySelectorAll('.radio-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === stationId) {
                    item.classList.add('active');
                }
            });
            
            if (station.geo_lat && station.geo_long) {
                map.setView([station.geo_lat, station.geo_long], 6);
            }
            
            audioPlayer.pause();
            
            const streamUrl = station.url_resolved || station.url;
            audioPlayer.src = streamUrl;
            audioPlayer.play().catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                document.getElementById('current-station').textContent = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–ç”µå°';
                document.getElementById('current-station').style.color = '#e52e71';
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
                
                setTimeout(() => {
                    if (document.getElementById('current-station')) {
                        document.getElementById('current-station').style.color = '';
                    }
                }, 3000);
            });
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // æ›´æ–°åœ°å›¾æ ‡è®°
        function updateMapMarkers(stations) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            stations.forEach(station => {
                if (station.geo_lat && station.geo_long) {
                    const flagEmoji = getFlagEmoji(station.countrycode);
                    
                    const marker = L.marker([station.geo_lat, station.geo_long])
                        .addTo(map)
                        .bindPopup(`
                            <div style="color: black; min-width: 200px;">
                                <b>${station.name || 'æœªçŸ¥ç”µå°'}</b><br>
                                ${station.country || ''}<br>
                                <small>${station.tags || ''}</small><br>
                                <button onclick="window.playStationFromMap('${station.stationuuid}')" 
                                        style="background:#e52e71;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;margin-top:5px;">
                                    æ’­æ”¾
                                </button>
                            </div>
                        `);
                    
                    markers.push(marker);
                }
            });
        }

        // ä»åœ°å›¾æ’­æ”¾ç”µå°
        window.playStationFromMap = function(stationId) {
            playStation(stationId);
        };

        // é˜²æŠ–æœç´¢
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300);
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const countryFilter = document.getElementById('country-filter').value;
            const languageFilter = document.getElementById('language-filter').value;
            const genreFilter = document.getElementById('genre-filter').value;
            
            filteredStations = allStations.filter(station => {
                const matchesSearch = searchTerm === '' || 
                    (station.name && station.name.toLowerCase().includes(searchTerm)) || 
                    (station.country && station.country.toLowerCase().includes(searchTerm)) ||
                    (station.tags && station.tags.toLowerCase().includes(searchTerm));
                
                const matchesCountry = countryFilter === '' || station.country === countryFilter;
                
                let matchesLanguage = true;
                if (languageFilter !== '') {
                    const englishKeyword = Object.keys(languageMapping).find(key => 
                        languageMapping[key] === languageFilter
                    ) || '';
                    matchesLanguage = station.language && 
                        station.language.toLowerCase().includes(englishKeyword.toLowerCase());
                }
                
                let matchesGenre = true;
                if (genreFilter !== '') {
                    const englishKeyword = Object.keys(genreMapping).find(key => 
                        genreMapping[key] === genreFilter
                    ) || '';
                    matchesGenre = station.tags && 
                        station.tags.toLowerCase().includes(englishKeyword.toLowerCase());
                }
                
                return matchesSearch && matchesCountry && matchesLanguage && matchesGenre;
            });
            
            displayedCount = 0;
            displayedStations = [];
            
            if (activeTab === 'all') {
                loadMoreStations();
            }
            
            updateMapMarkers(filteredStations.slice(0, 200));
        }

        // åŠ è½½å¤‡ç”¨æ•°æ®
        function loadFallbackData() {
            // ç®€åŒ–çš„ç¤ºä¾‹æ•°æ®
            allStations = [
                {
                    stationuuid: '1',
                    name: 'BBC Radio 1',
                    country: 'United Kingdom',
                    countrycode: 'GB',
                    url_resolved: 'https://stream.live.vc.bbcmedia.co.uk/bbc_radio_one',
                    tags: 'pop,music',
                    language: 'english',
                    votes: 1000,
                    geo_lat: 51.5074,
                    geo_long: -0.1278
                },
                // ... æ›´å¤šç¤ºä¾‹æ•°æ®
            ];
            
            filteredStations = [...allStations];
            processStationsData(allStations);
            updateDataSource('ç¤ºä¾‹æ•°æ®');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadLocalData();
            loadPreprocessedData();
            
            // äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('search-input').addEventListener('input', debounceSearch);
            document.getElementById('country-filter').addEventListener('change', performSearch);
            document.getElementById('language-filter').addEventListener('change', performSearch);
            document.getElementById('genre-filter').addEventListener('change', performSearch);
            document.getElementById('load-more-btn').addEventListener('click', loadMoreStations);

            // æ’­æ”¾æ§åˆ¶
            document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('stop-btn').addEventListener('click', stopPlayback);
            document.querySelector('.volume-slider').addEventListener('input', updateVolume);
            document.getElementById('share-btn').addEventListener('click', shareStation);
        });

        // å…¶ä»–è¾…åŠ©å‡½æ•°...
        function getFlagEmoji(countryCode) {
            if (!countryCode) return 'ğŸŒ';
            const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        function toggleFavorite(stationId) {
            const station = allStations.find(s => s.stationuuid === stationId);
            if (!station) return;
            
            const index = favoriteStations.findIndex(fav => fav.stationuuid === stationId);
            
            if (index === -1) {
                favoriteStations.push(station);
            } else {
                favoriteStations.splice(index, 1);
            }
            
            saveLocalData();
            
            if (activeTab === 'all') {
                renderRadioList();
            } else if (activeTab === 'favorites') {
                updateTabs();
            }
        }

        function addToHistory(station) {
            const existingIndex = historyStations.findIndex(item => 
                item.station.stationuuid === station.stationuuid
            );
            
            if (existingIndex !== -1) {
                historyStations.splice(existingIndex, 1);
            }
            
            historyStations.push({
                station: station,
                timestamp: Date.now()
            });
            
            if (historyStations.length > 50) {
                historyStations = historyStations.slice(-50);
            }
            
            saveLocalData();
            
            if (activeTab === 'history') {
                updateTabs();
            }
        }

        function loadLocalData() {
            const storedFavorites = localStorage.getItem('radioFavorites');
            const storedHistory = localStorage.getItem('radioHistory');
            
            if (storedFavorites) {
                favoriteStations = JSON.parse(storedFavorites);
            }
            
            if (storedHistory) {
                historyStations = JSON.parse(storedHistory);
            }
        }

        function saveLocalData() {
            localStorage.setItem('radioFavorites', JSON.stringify(favoriteStations));
            localStorage.setItem('radioHistory', JSON.stringify(historyStations));
        }

        function togglePlayPause() {
            if (!currentStation) {
                if (filteredStations.length > 0) {
                    playStation(filteredStations[0].stationuuid);
                }
                return;
            }
            
            if (isPlaying) {
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
                audioPlayer.pause();
            } else {
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
                audioPlayer.play().catch(error => {
                    console.error('æ’­æ”¾å¤±è´¥:', error);
                    document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
                });
            }
            
            isPlaying = !isPlaying;
        }

        function stopPlayback() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            isPlaying = false;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
        }

        function updateVolume() {
            audioPlayer.volume = document.querySelector('.volume-slider').value / 100;
        }

        function shareStation() {
            if (!currentStation) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”µå°');
                return;
            }
            
            const stationName = currentStation.name;
            const stationUrl = currentStation.url_resolved || currentStation.url;
            
            if (navigator.share) {
                navigator.share({
                    title: stationName,
                    text: 'æˆ‘æ­£åœ¨æ”¶å¬è¿™ä¸ªç”µå°',
                    url: stationUrl
                });
            } else {
                navigator.clipboard.writeText(`${stationName} - ${stationUrl}`).then(() => {
                    alert('ç”µå°é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            }
        }

        function updateTabs() {
            if (activeTab === 'favorites') {
                renderRadioList(favoriteStations, document.getElementById('favorites-list'), 'favorites');
            } else if (activeTab === 'history') {
                renderHistoryList();
            }
        }

        function renderHistoryList() {
            const historyList = document.getElementById('history-list');
            
            if (historyStations.length === 0) {
                historyList.innerHTML = '<div class="loading">æš‚æ— æ’­æ”¾å†å²</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            const recentHistory = historyStations.slice(-20).reverse();
            
            recentHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.id = item.station.stationuuid;
                
                const flagEmoji = getFlagEmoji(item.station.countrycode);
                const timeString = new Date(item.timestamp).toLocaleString();
                
                historyItem.innerHTML = `
                    <div class="radio-flag">${flagEmoji}</div>
                    <div class="radio-info">
                        <div class="radio-name">${item.station.name || 'æœªçŸ¥ç”µå°'}</div>
                        <div class="radio-country">${item.station.country || 'æœªçŸ¥å›½å®¶'}</div>
                        <div class="history-time">${timeString}</div>
                    </div>
                    <button class="play-btn" data-id="${item.station.stationuuid}">
                        <i class="fas fa-play"></i>
                    </button>
                `;
                
                historyList.appendChild(historyItem);
            });
            
            attachEventListeners();
        }
    </script>
</body>
</html>
